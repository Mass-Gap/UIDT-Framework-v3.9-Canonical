name: UIDT PR Review

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  check-format:
    name: Check Commit Message Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check UIDT commit format
        run: |
          # Get all commits in this PR (from merge-base to HEAD)
          commits=$(git rev-list origin/main..HEAD)
          failed=0

          for commit in $commits; do
            msg=$(git log -1 --format=%B $commit)

            # Check for [UIDT] prefix
            if ! echo "$msg" | grep -q '^\[UIDT\]'; then
              echo "‚ùå FAIL: Commit $commit missing [UIDT] prefix"
              echo "   Format: [UIDT] <type>: <summary>"
              failed=1
            fi

            # Check for evidence category [A-E]
            if ! echo "$msg" | grep -qE '\[A-E\]|Evidence category:'; then
              echo "‚ö†Ô∏è  WARN: Commit $commit missing evidence category tag"
              failed=1
            fi
          done

          if [ $failed -eq 1 ]; then
            echo ""
            echo "Please fix commit messages and force-push:"
            echo "  git rebase -i origin/main"
            exit 1
          fi

          echo "‚úÖ All commits follow UIDT format"
        continue-on-error: true

      - name: Comment PR - Format Check
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const checkResult = "${{ job.status }}" === "success" ? "‚úÖ PASS" : "‚ùå FAIL";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç UIDT Format Check: ${checkResult}

Commit message format must follow: \`[UIDT] <type>: <summary>\`

**Types:** fix, docs, test, check, classify, placeholder
**Evidence:** Include [A], [A-], [B], [C], [D], or [E]
**Example:** \`[UIDT] docs: update falsification criteria (Evidence: [D])\`

---
`
            });

  check-protected-paths:
    name: Check Protected Paths
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Verify no protected paths modified
        run: |
          # Get changed files
          files=$(git diff --name-only origin/main..HEAD)
          protected_paths=("core/" "releases/" "CANONICAL/" "docs/")
          failed=0

          for file in $files; do
            for protected in "${protected_paths[@]}"; do
              if [[ $file == $protected* ]]; then
                if [[ $protected == "docs/" ]]; then
                  # docs/ is protected in CI but readable elsewhere
                  echo "‚ö†Ô∏è  WARN: Modified protected documentation: $file"
                else
                  echo "‚ùå FAIL: Cannot modify protected path: $file"
                  failed=1
                fi
              fi
            done
          done

          # Check for mp.dps changes
          if git diff origin/main..HEAD | grep -qE '\.dps\s*=|mp\.dps\s*!=\s*80'; then
            echo "‚ùå FAIL: mp.dps precision change detected"
            echo "   mp.dps MUST remain 80 in all modules"
            failed=1
          fi

          # Check for excessive deletions in core/modules
          for file in $files; do
            if [[ $file == "core/"* ]] || [[ $file == "modules/"* ]]; then
              deletions=$(git diff origin/main..HEAD -- "$file" | grep '^-' | wc -l)
              if [ $deletions -gt 10 ]; then
                echo "‚ùå FAIL: Too many deletions in $file ($deletions lines)"
                echo "   Maximum 10 lines per commit in core/ or modules/"
                failed=1
              fi
            fi
          done

          if [ $failed -eq 1 ]; then
            exit 1
          fi

          echo "‚úÖ Protected paths and constraints verified"
        continue-on-error: true

      - name: Comment PR - Protected Paths Check
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const checkResult = "${{ job.status }}" === "success" ? "‚úÖ PASS" : "‚ùå FAIL";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîí Protected Paths Check: ${checkResult}

**Protected (read-only) paths:**
- \`core/\` ‚Äî Core QFT system, only bug fixes
- \`releases/\` ‚Äî Artifact archive, CI-managed
- \`CANONICAL/\` ‚Äî Immutable reference data

**Numerical Constraints:**
- \`mp.dps\` must = 80 (never less, never mocked)
- Max 10 line deletions per commit in core/ or modules/

---
`
            });

  run-verification:
    name: Run UIDT Verification Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run UIDT-3.6.1 Verification
        id: verify_36
        run: |
          python verification/scripts/UIDT-3.6.1-Verification.py 2>&1 | tee verification_36.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run UIDT Master Verification (v3.9)
        id: verify_master
        run: |
          python verification/scripts/UIDT_Master_Verification.py 2>&1 | tee verification_master.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run CSF-UIDT Unification Verification
        id: verify_csf
        run: |
          python verification/scripts/verify_csf_unification.py 2>&1 | tee verification_csf.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse verification results
        id: parse_results
        run: |
          # Extract residual information from logs
          residuals_36=$(grep -i "residual" verification_36.log | head -1 || echo "N/A")
          residuals_master=$(grep -i "residual" verification_master.log | head -1 || echo "N/A")
          residuals_csf=$(grep -i "residual" verification_csf.log | head -1 || echo "N/A")

          echo "residuals_36=$residuals_36" >> $GITHUB_OUTPUT
          echo "residuals_master=$residuals_master" >> $GITHUB_OUTPUT
          echo "residuals_csf=$residuals_csf" >> $GITHUB_OUTPUT

          # Determine pass/fail
          if [ "${{ steps.verify_36.outputs.exit_code }}" -eq 0 ] && [ "${{ steps.verify_master.outputs.exit_code }}" -eq 0 ] && [ "${{ steps.verify_csf.outputs.exit_code }}" -eq 0 ]; then
            echo "verification_status=PASS" >> $GITHUB_OUTPUT
          else
            echo "verification_status=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR - Verification Results
        uses: actions/github-script@v6
        with:
          script: |
            const verificationStatus = "${{ steps.parse_results.outputs.verification_status }}";
            const residuals36 = "${{ steps.parse_results.outputs.residuals_36 }}";
            const residualsMaster = "${{ steps.parse_results.outputs.residuals_master }}";
            const residualsCSF = "${{ steps.parse_results.outputs.residuals_csf }}";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Verification Suite: ${verificationStatus}

**UIDT-3.6.1 Verification:**
\`\`\`
${residuals36}
\`\`\`

**UIDT Master (v3.9) Verification:**
\`\`\`
${residualsMaster}
\`\`\`

**CSF-UIDT Unification (Category C):**
\`\`\`
${residualsCSF}
\`\`\`

**Requirement:** All residuals < 10^-14 for Category A claims

---
`
            });

  pr-review-summary:
    name: PR Review Summary
    runs-on: ubuntu-latest
    needs: [ check-format, check-protected-paths, run-verification ]
    if: always()
    steps:
      - name: Determine overall status
        id: summary
        run: |
          format_status="${{ needs.check-format.result }}"
          paths_status="${{ needs.check-protected-paths.result }}"
          verify_status="${{ needs.run-verification.result }}"

          # Map result names to symbols
          format_icon=$([ "$format_status" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          paths_icon=$([ "$paths_status" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          verify_icon=$([ "$verify_status" = "success" ] && echo "‚úÖ" || echo "‚ùå")

          echo "format_icon=$format_icon" >> $GITHUB_OUTPUT
          echo "paths_icon=$paths_icon" >> $GITHUB_OUTPUT
          echo "verify_icon=$verify_icon" >> $GITHUB_OUTPUT

      - name: Final PR Comment
        uses: actions/github-script@v6
        with:
          script: |
            const formatIcon = "${{ steps.summary.outputs.format_icon }}";
            const pathsIcon = "${{ steps.summary.outputs.paths_icon }}";
            const verifyIcon = "${{ steps.summary.outputs.verify_icon }}";

            const allPass = formatIcon === "‚úÖ" && pathsIcon === "‚úÖ" && verifyIcon === "‚úÖ";
            const decision = allPass
              ? "üü¢ **AWAITING CLAUDE REVIEW** (all checks pass)"
              : "üî¥ **BLOCKED** (fix issues above before Claude review)";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä UIDT PR Review Summary

| Check | Result |
|---|---|
| Format | ${formatIcon} |
| Protected Paths | ${pathsIcon} |
| Verification | ${verifyIcon} |

### Decision: ${decision}

**Next Steps:**
1. Review all checks above
2. If blocked: fix issues and push to same branch
3. If passing: Claude will perform scientific review and decide to approve/block

---
*Automated by UIDT-OS PR Review System*
`
            });
