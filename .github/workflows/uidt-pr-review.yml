name: UIDT PR Review

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  uidt-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate commit message format
        id: commit_check
        continue-on-error: true
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "Commit message:"
          echo "$COMMIT_MSG"

          if [[ ! "$COMMIT_MSG" =~ ^

\[UIDT\]

\ (fix|docs|test|check|classify|placeholder):\ .*\ \(Evidence:\ 

\[[A-E]-?\]

\)$ ]]; then
            echo "‚ùå Invalid commit message format"
            exit 1
          fi

          echo "‚úÖ Commit message format valid"

      - name: Comment PR - Format Check
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const checkResult = "${{ steps.commit_check.outcome }}" === "success" ? "‚úÖ PASS" : "‚ùå FAIL";
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç UIDT Format Check: ${checkResult}

Commit message format must follow \`[UIDT] <type>: <summary> (Evidence: [X])\`

**Allowed types:** fix, docs, test, check, classify, placeholder  
**Evidence levels:** [A], [A-], [B], [C], [D], [E]

**Example:**  
\`[UIDT] docs: update falsification criteria (Evidence: [D])\`
`
            });

      - name: Protected paths check
        continue-on-error: true
        run: |
          echo "Protected paths verification placeholder"

      - name: UIDT verification suite
        continue-on-error: true
        run: |
          echo "UIDT verification suite placeholder"

      - name: Final PR summary
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### üìä UIDT PR Review Summary

- Commit format check: **${{ steps.commit_check.outcome }}**
- Protected paths: executed
- Verification suite: executed

This review is **non-blocking** unless explicitly enforced by repository rules.
`
            });
